<h1 class="my-4"><%= t.admin.page %></h1>

<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th><%= t.admin.id %></th>
        <th><%= t.admin.username %></th>
        <th><%= t.login.password %></th>
        <th><%= t.admin.email %></th>
        <th><%= t.admin.verified %></th>
        <th><%= t.admin.admin %></th>
        <th><%= t.admin.actions %></th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td><%= user['id'] %></td>
          <td>
            <input type="text" class="form-control" name="username" value="<%= user['username'] %>" data-user-id="<%= user['id'] %>" />
          </td>
          <td>
            
          </td>
          <td>
            <input type="email" class="form-control" name="email" value="<%= user['email'] %>" data-user-id="<%= user['id'] %>" />
          </td>
          <td>
            <select class="form-select" data-user-id="<%= user['id'] %>" name="verified">
              <option value="1" <%= user['verified'] == 1 ? 'selected' : '' %>><%= t.general.y %></option>
              <option value="0" <%= user['verified'] == 0 ? 'selected' : '' %>><%= t.general.n %></option>
            </select>
          </td>
          <td>
            <select class="form-select" data-user-id="<%= user['id'] %>" name="admin">
              <option value="1" <%= user['admin'] == 1 ? 'selected' : '' %>><%= t.general.y %></option>
              <option value="0" <%= user['admin'] == 0 ? 'selected' : '' %>><%= t.general.n %></option>
            </select>
          </td>
          <td>
            <button class="btn btn-success btn-sm save-user" data-user-id="<%= user['id'] %>"><%= t.general.submit %></button>
            <form action="/admin/delete/<%= user['id'] %>" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this user?');"><%= t.general.remove %></button>
            </form>
          </td>
        </tr>
      <% end %>

      <!-- New User Row -->
      <tr>
        <td>New</td>
        <td><input type="text" class="form-control" name="new_username" placeholder="<%= t.login.username %>"></td>
        <td><input type="text" class="form-control" name="new_password" placeholder="<%= t.login.password %>"></td>
        <td><input type="email" class="form-control" name="new_email" placeholder="<%= t.signup.email %>"></td>
        <td>
          <select class="form-select" name="new_verified">
            <option value="1"><%= t.general.y %></option>
            <option value="0"><%= t.general.n %></option>
          </select>
        </td>
        <td>
          <select class="form-select" name="new_admin">
            <option value="1"><%= t.general.y %></option>
            <option value="0"><%= t.general.n %></option>
          </select>
        </td>
        <td>
          <button class="btn btn-primary btn-sm add-new-user"><%= t.general.submit %></button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  document.querySelectorAll('.save-user').forEach(button => {
    button.addEventListener('click', () => {
      const userId = button.getAttribute('data-user-id');
      const username = button.closest('tr').querySelector('input[name="username"]').value;
      const email = button.closest('tr').querySelector('input[name="email"]').value;
      const verified = button.closest('tr').querySelector('select[name="verified"]').value;
      const admin = button.closest('tr').querySelector('select[name="admin"]').value;

      fetch(`/admin/update/${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, email, verified, admin }),
      })
      .then(response => response.json())
      .then(json => {
        if (json.status === 'success') {
          alert('User updated successfully!');
        } else {
          alert('Error updating user: ' + json.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An unexpected error occurred.');
      });
    });
  });

  // Add new user functionality
  document.querySelector('.add-new-user').addEventListener('click', () => {
    const username = document.querySelector('input[name="new_username"]').value;
    const password = document.querySelector('input[name="new_password"]').value;
    const email = document.querySelector('input[name="new_email"]').value;
    const verified = document.querySelector('select[name="new_verified"]').value;
    const admin = document.querySelector('select[name="new_admin"]').value;

    fetch('/admin/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ username, password, email, verified, admin }),
    })
    .then(response => response.json())
    .then(json => {
      if (json.status === 'success') {
        alert('New user added successfully!');
        location.reload(); // Optionally reload the page to see the new user in the list
      } else {
        alert('Error adding user: ' + json.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An unexpected error occurred.');
    });
  });
</script>
